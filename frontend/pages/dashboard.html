<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد - سیستم کارپردازی</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://unpkg.com/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-journal-bookmark"></i>
                سیستم ثبت عملیات کارپردازی
            </span>
            <div class="d-flex">
                <span class="text-white me-3" id="userWelcome">خوش آمدید</span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">خروج</button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- سایدبار -->
            <div class="col-md-3 col-lg-2 sidebar bg-light">
                <h4 class="text-center border-bottom pb-2 pt-3">دفاتر من</h4>
                <div id="ledgersList" class="list-group mt-3">
                    <!-- لیست دفاتر در اینجا لود می‌شود -->
                </div>
                <button class="btn btn-primary mt-3 w-100" onclick="showAddLedgerModal()">
                    <i class="bi bi-plus-circle"></i> افزودن دفتر جدید
                </button>
            </div>

            <!-- محتوای اصلی -->
            <div class="col-md-9 col-lg-10 main-content">
                <div id="noLedgerSelected" class="text-center mt-5">
                    <i class="bi bi-journal-text display-1 text-muted"></i>
                    <h3 class="text-muted mt-3">لطفاً یک دفتر انتخاب کنید</h3>
                    <p class="text-muted">برای شروع کار، یک دفتر از لیست سمت راست انتخاب کنید یا دفتر جدیدی ایجاد نمایید.</p>
                </div>

                <div id="ledgerContent" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4 mt-3">
                        <h3 id="currentLedgerTitle">عنوان دفتر</h3>
                        <div>
                            <button class="btn btn-success me-2" onclick="showAddTransactionModal()">
                                <i class="bi bi-plus-lg"></i> تراکنش جدید
                            </button>
                            <button class="btn btn-outline-secondary me-2" onclick="showAddFiscalYearModal()">
                                <i class="bi bi-calendar-plus"></i> سال مالی جدید
                            </button>
                            <button class="btn btn-outline-info" onclick="showManageFiscalYearsModal()">
                                <i class="bi bi-gear"></i> مدیریت سال‌های مالی
                            </button>
                        </div>
                    </div>

                    <!-- انتخاب سال مالی -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label for="fiscalYearSelect" class="form-label">سال مالی:</label>
                            <select class="form-select" id="fiscalYearSelect" onchange="onFiscalYearChange()">
                                <option value="">انتخاب سال مالی</option>
                            </select>
                        </div>
                    </div>

                    <!-- خلاصه مالی -->
                    <div class="row mb-4" id="financialSummary" style="display: none;">
                        <div class="col-md-2 mb-3">
                            <div class="card text-white bg-success financial-card h-100">
                                <div class="card-body text-center">
                                    <h6>مبلغ دریافتی</h6>
                                    <h4 id="totalReceived">0</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="card text-white bg-danger financial-card h-100">
                                <div class="card-body text-center">
                                    <h6>مبلغ پرداختی</h6>
                                    <h4 id="totalPaid">0</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="card text-white bg-info financial-card h-100">
                                <div class="card-body text-center">
                                    <h6>موجودی</h6>
                                    <h4 id="totalBalance">0</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="card text-white bg-warning financial-card h-100">
                                <div class="card-body text-center">
                                    <h6>هزینه دریافتی</h6>
                                    <h4 id="totalCostReceived">0</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="card text-white bg-secondary financial-card h-100">
                                <div class="card-body text-center">
                                    <h6>هزینه ارسال شده</h6>
                                    <h4 id="totalCostSent">0</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="card text-white bg-dark financial-card h-100">
                                <div class="card-body text-center">
                                    <h6>هزینه واخواهی شده</h6>
                                    <h4 id="totalCostRecalled">0</h4>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- جدول تراکنش‌ها -->
                    <div class="table-responsive" id="transactionsSection" style="display: none;">
                        <table class="table table-striped table-hover transaction-table">
                            <thead class="table-dark">
                                <tr>
                                    <th>تاریخ</th>
                                    <th>نوع تراکنش</th>
                                    <th>عنوان</th>
                                    <th>مبلغ دریافتی</th>
                                    <th>مبلغ پرداختی</th>
                                    <th>موجودی</th>
                                    <th>هزینه دریافتی</th>
                                    <th>هزینه ارسال شده</th>
                                    <th>هزینه واخواهی شده</th>
                                    <th>عملیات</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTable">
                                <!-- تراکنش‌ها در اینجا لود می‌شوند -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال‌ها (همانند قبل) -->
    <!-- مودال افزودن دفتر -->
    <div class="modal fade" id="addLedgerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">افزودن دفتر جدید</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addLedgerForm">
                        <div class="mb-3">
                            <label for="ledgerTitle" class="form-label">عنوان دفتر</label>
                            <input type="text" class="form-control" id="ledgerTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="initialDebt" class="form-label">مانده بدهی اولیه</label>
                            <input type="number" class="form-control" id="initialDebt" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">تفکیک مانده بدهی:</label>
                            <input type="number" class="form-control mb-2" id="initialCash" step="0.01" placeholder="موجودی نقد" required>
                            <input type="number" class="form-control mb-2" id="initialPendingCost" step="0.01" placeholder="هزینه ارسال نشده اولیه" required>
                            <input type="number" class="form-control" id="initialVendorInvoice" step="0.01" placeholder="فاکتور نزد فروشنده" required>
                            <small class="text-muted">جمع موارد بالا باید برابر با مانده بدهی باشد</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                    <button type="button" class="btn btn-primary" onclick="createLedger()">ذخیره</button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال افزودن سال مالی -->
    <div class="modal fade" id="addFiscalYearModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">افزودن سال مالی جدید</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addFiscalYearForm">
                        <input type="hidden" id="fiscalYearLedgerId">
                        <div class="mb-3">
                            <label for="fiscalYearTitle" class="form-label">عنوان سال مالی *</label>
                            <input type="text" class="form-control" id="fiscalYearTitle" 
                                   placeholder="مثال: ۱۴۰۳-۱۴۰۴" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="startDate" class="form-label">تاریخ شروع *</label>
                                    <input type="text" class="form-control persian-datepicker" id="startDate" 
                                           placeholder="انتخاب تاریخ شروع" required readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="endDate" class="form-label">تاریخ پایان *</label>
                                    <input type="text" class="form-control persian-datepicker" id="endDate" 
                                           placeholder="انتخاب تاریخ پایان" required readonly>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="isActive" checked>
                            <label class="form-check-label" for="isActive">سال مالی فعال</label>
                        </div>
                        <div class="alert alert-info">
                            <small>
                                <i class="bi bi-info-circle"></i>
                                سال مالی جدید به دفتر "<span id="currentLedgerName"></span>" اختصاص داده می‌شود
                            </small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                    <button type="button" class="btn btn-primary" onclick="createFiscalYear()">ذخیره سال مالی</button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال مدیریت سال‌های مالی -->
    <div class="modal fade" id="manageFiscalYearsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">مدیریت سال‌های مالی</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>سال‌های مالی دفتر: <span id="manageLedgerName"></span></h6>
                        <button class="btn btn-sm btn-success" onclick="showAddFiscalYearModal()">
                            <i class="bi bi-plus-circle"></i> افزودن سال مالی
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>سال مالی</th>
                                    <th>تاریخ شروع</th>
                                    <th>تاریخ پایان</th>
                                    <th>وضعیت</th>
                                    <th>تعداد تراکنش‌ها</th>
                                    <th>عملیات</th>
                                </tr>
                            </thead>
                            <tbody id="fiscalYearsManagementTable">
                                <!-- لیست سال‌های مالی -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال افزودن تراکنش -->
    <div class="modal fade" id="addTransactionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ثبت تراکنش جدید</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addTransactionForm">
                        <input type="hidden" id="transactionFiscalYearId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="transactionDate" class="form-label">تاریخ تراکنش *</label>
                                    <input type="text" class="form-control persian-datepicker" id="transactionDate" 
                                           placeholder="انتخاب تاریخ تراکنش" required readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="transactionType" class="form-label">نوع تراکنش *</label>
                                    <select class="form-select" id="transactionType" required>
                                        <option value="">انتخاب نوع تراکنش</option>
                                        <option value="دریافت وجه">دریافت وجه</option>
                                        <option value="پرداخت وجه بدون فاکتور">پرداخت وجه بدون فاکتور</option>
                                        <option value="پرداخت وجه با فاکتور">پرداخت وجه با فاکتور</option>
                                        <option value="دریافت هزینه">دریافت هزینه</option>
                                        <option value="ارسال هزینه">ارسال هزینه</option>
                                        <option value="واخواهی هزینه">واخواهی هزینه</option>
                                        <option value="عودت مبلغ دریافتی">عودت مبلغ دریافتی</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="transactionTitle" class="form-label">عنوان تراکنش *</label>
                            <input type="text" class="form-control" id="transactionTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="transactionAmount" class="form-label">مبلغ (ریال) *</label>
                            <input type="number" class="form-control" id="transactionAmount" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="transactionDescription" class="form-label">توضیحات</label>
                            <textarea class="form-control" id="transactionDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                    <button type="button" class="btn btn-primary" onclick="createTransaction()">ذخیره تراکنش</button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال ویرایش تراکنش -->
    <div class="modal fade" id="editTransactionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ویرایش تراکنش</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editTransactionForm">
                        <input type="hidden" id="editTransactionId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editTransactionDate" class="form-label">تاریخ تراکنش *</label>
                                    <input type="text" class="form-control persian-datepicker" id="editTransactionDate" 
                                           placeholder="انتخاب تاریخ تراکنش" required readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editTransactionType" class="form-label">نوع تراکنش *</label>
                                    <select class="form-select" id="editTransactionType" required>
                                        <option value="">انتخاب نوع تراکنش</option>
                                        <option value="دریافت وجه">دریافت وجه</option>
                                        <option value="پرداخت وجه بدون فاکتور">پرداخت وجه بدون فاکتور</option>
                                        <option value="پرداخت وجه با فاکتور">پرداخت وجه با فاکتور</option>
                                        <option value="دریافت هزینه">دریافت هزینه</option>
                                        <option value="ارسال هزینه">ارسال هزینه</option>
                                        <option value="واخواهی هزینه">واخواهی هزینه</option>
                                        <option value="عودت مبلغ دریافتی">عودت مبلغ دریافتی</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editTransactionTitle" class="form-label">عنوان تراکنش *</label>
                            <input type="text" class="form-control" id="editTransactionTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="editTransactionAmount" class="form-label">مبلغ (ریال) *</label>
                            <input type="number" class="form-control" id="editTransactionAmount" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="editTransactionDescription" class="form-label">توضیحات</label>
                            <textarea class="form-control" id="editTransactionDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                    <button type="button" class="btn btn-primary" onclick="updateTransaction()">بروزرسانی تراکنش</button>
                </div>
            </div>
        </div>
    </div>

    <!-- کتابخانه‌های مورد نیاز -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/dashboard.js"></script>
</body>
</html>